<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>房間預訂｜Google Material Card UI</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --primary:#4285F4;
  --surface:#FFF;
  --surface2:#F2F4F7;
  --radius:18px;
  --input:#e8eaf3;
}
body{
  font-family:"Noto Sans TC",sans-serif;
  background:var(--surface2);
  margin:0; padding:0;
}
header{
  background:var(--primary);
  color:#fff;
  padding:18px;
  text-align:center;
  font-size:20px;
  font-weight:700;
  letter-spacing:.5px;
}

/* === Card === */
.card{
  background:var(--surface);
  border-radius:var(--radius);
  max-width:480px;
  margin:26px auto;
  padding:24px;
  box-shadow:0 4px 16px rgba(0,0,0,.07);
}

/* 標題區 */
.card h2{
  margin:0;
  font-size:22px;
  font-weight:700;
}

/* Input Material風格 */
label{margin-top:18px; display:block; font-weight:600;}
input,select,textarea{
  width:100%;
  margin-top:8px;
  padding:12px;
  border:none;
  background:var(--input);
  border-radius:12px;
  font-size:16px;
  outline:none;
  transition:.25s;
}
input:focus,select:focus,textarea:focus{
  background:#dce8ff;
}

/* 價格顯示區 */
.price-box{
  margin-top:26px;
  padding:18px;
  border-radius:var(--radius);
  background:#f9fbff;
  border:1px solid #dce6ff;
}
.summary{
  font-size:16px;
  color:#444;
}
.total{
  font-size:26px;
  font-weight:700;
  color:#E53935;
  text-align:right;
}

/* Button */
.btn{
  width:100%;
  background:var(--primary);
  color:white;
  padding:14px;
  border:none;
  border-radius:14px;
  font-size:18px;
  font-weight:600;
  margin-top:22px;
  cursor:pointer;
  transition:.25s;
}
.btn:hover{opacity:.85;}
</style>
</head>

<body>

<header>Google Material Card 預訂房間</header>

<div class="card">

  <h2 id="room_name">讀取中...</h2>

  <label>入住日期</label>
  <input type="date" id="checkin">

  <label>退房日期</label>
  <input type="date" id="checkout">

  <label>大人</label>
  <select id="adult">
    <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
  </select>

  <label>孩童</label>
  <select id="child">
    <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option>
  </select>

  <label>備註</label>
  <textarea id="note" rows="3" placeholder="特殊需求、加床、飲食過敏等"></textarea>

  <!-- 價格卡片 -->
  <div class="price-box">
    <div class="summary">入住晚數：<b><span id="nights">0</span></b> 晚</div>
    <div class="total">NT$ <span id="price">0</span></div>
  </div>

  <button class="btn" onclick="submitBooking()">✔ 確認預訂</button>
</div>

<script>
const API="YOUR_GAS_URL"; // ←必填
const room=new URLSearchParams(location.search).get("room");
let roomData,calendar=[];

// 讀取房型資料
async function init(){
  const rooms=await fetch(API+"?action=rooms").then(r=>r.json());
  roomData=rooms.find(r=>r.id===room);
  room_name.innerText=roomData.name;

  // load calendar
  calendar=await fetch(API+"?action=calendar").then(r=>r.json());
}
init();

// 計算價格 & 禁用滿房
function calc(){
  if(!checkin.value||!checkout.value) return;
  const a=new Date(checkin.value),b=new Date(checkout.value);
  const diff=(b-a)/86400000;
  if(diff<=0){checkout.value="";return alert("⚠ 退房日需大於入住日");}

  nights.innerText=diff;
  let total=0;

  for(let i=0;i<diff;i++){
    let d=new Date(checkin.value); d.setDate(d.getDate()+i);
    let isWeekend=[0,6].includes(d.getDay());
    total+=isWeekend?roomData.weekend:roomData.weekday;

    // 房況滿房檢查
    let dd=d.toISOString().split("T")[0];
    let item=calendar.find(c=>c.date===dd&&c.room_id===room);
    if(item && item.used>=item.stock){
      alert("❌ "+dd+" 此房型已滿房");
      checkout.value=""; price.innerText="0";
      return;
    }
  }

  price.innerText=total;
}
checkin.onchange=calc; checkout.onchange=calc;

// 送出訂單
async function submitBooking(){
  const body={
    room_id:room,
    name:prompt("請輸入姓名："),
    phone:prompt("手機（10碼）："),
    checkin:checkin.value, checkout:checkout.value,
    adult:adult.value, child:child.value, note:note.value
  };

  const res=await fetch(API+"?action=createBooking",{method:"POST",body:JSON.stringify(body)}).then(r=>r.json());

  if(res.success)location.href="success.html?id="+res.order_id+"&price="+res.price;
  else alert("⚠ "+res.message);
}
</script>

</body>
</html>
